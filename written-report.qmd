---
title: "Lead in the Water: The Effects of Blood Lead Levels on Incareration Rates"
subtitle: An Analysis
author: "staRstistions - Will Lieber, Wania Iftikhar Khan, AJ Tenser, Kami Akala"
date: "April 10 2025"
format: pdf
execute: 
  warning: false
  message: false
  echo: false
editor: visual
---

```{r}
#| label: load packages and data
#| echo: FALSE
#| warning: false
#| message: false

library(tidyverse)
library(tidymodels)
library(patchwork)
library(ggplot2)
library(readxl)  
library(dplyr)
library(knitr)
library(rms)
library(readr)
library(GGally)


ca_incarceration <- read_excel("data/census_tract_prison.xlsx")
ca_lead <- read_excel("data/New_census_tract_lead_level.xlsx")

ca_demographic <- read_csv("data/demographic.csv", skip = 1)
ca_income <- read_csv("data/income.csv", skip = 1)

#demographics
ca_demographic <- ca_demographic |>
  select(c(1:3, 27, 75, 164:176, 240:245)) |>
  rename_with(~ str_replace(., ".*!!", "")) |>
  filter(Geography != "0400000US06")

ca_demographic <- ca_demographic |>
  mutate(`Geography` = substr(`Geography`, 10, 20)) |>
  mutate(across(!(1:2), as.numeric)) |>
  mutate(`0_to_14` = 
           `Under 5 years` + `5 to 9 years` + 
           `10 to 14 years`,
         
         `15_to_29` =
           `15 to 19 years` + `20 to 24 years` +
           `25 to 29 years`,
         
         `30_to_44` = 
           `30 to 34 years` + `35 to 39 years` +
           `40 to 44 years`,
         
         `45_to_64` = 
           `45 to 49 years` + `50 to 54 years` + 
           `55 to 59 years` + `60 to 64 years`
         ) |>
  mutate(perc_male = `Male population` / `Total population` * 100) |>
  select(!6:18) |>
  rename(census_tract = "Geography") |>
  rename(median_age = "Both sexes")


#income
ca_income <- ca_income |>
  select(c(1, 2, 25)) |>
  rename_with(~ str_replace(., ".*!!", "")) |>
  filter(Geography != "0400000US06")

ca_income <- ca_income |>
  mutate(`Geography` = substr(`Geography`, 10, 20)) |>
  mutate(across(!(1:2), as.numeric)) |>
  rename(census_tract = "Geography")


#incarceration
ca_incarceration <- ca_incarceration |>
  select(c(1, 2, 6)) |>
  mutate(fips = paste0("0", fips)) |>
  rename(census_tract = `fips`) |>
  mutate(across(!(1:2), as.numeric))


#lead
ca_lead <- ca_lead |>
  select(!1) |>
  mutate(`Census Tract` = paste0("0", `Census Tract`)) |>
  rename(census_tract = `Census Tract`) |>
  mutate(across(!1, as.numeric)) |>
  mutate(`Percent of children under 6 with a BLL of 3.5 µg/dL or greater` = 
           `Percent of children under 6 with a BLL of 3.5 µg/dL or greater` * 100)

#joining
joined_data1 <- left_join(ca_lead, ca_incarceration, by = "census_tract")
joined_data2 <- left_join(joined_data1, ca_demographic, by = "census_tract")

joined_data <- left_join(joined_data2, ca_income, by = "census_tract")

#post-join cleaning
bll_data <- joined_data |>
  janitor::clean_names() |>
  select(!c(geographic_area_name_x, geographic_area_name_y)) |>
  rename(num_bll_indicator = 
           number_of_children_under_6_with_a_bll_of_3_5_mg_d_l_or_greater) |>
  rename(perc_bll_indicator =
           percent_of_children_under_6_with_a_bll_of_3_5_mg_d_l_or_greater) |>
  rename(num_bll = 
           total_number_of_children_under_6_with_a_bll) |>
  rename(imprisonment_rt = imprisonment_rate_per_100_000) |>
  rename(tract_name = ca_census_tracts) |>
  rename(other_race = some_other_race) |>
  rename(black = black_or_african_american) |>
  rename(native_am = american_indian_and_alaska_native) |>
  rename(pac_islander = native_hawaiian_and_other_pacific_islander) |>
  rename(age_0_to_14 = x0_to_14) |>
  rename(age_15_to_29 = x15_to_29) |>
  rename(age_30_to_44 = x30_to_44) |>
  rename(age_45_to_64 = x45_to_64) |>
  rename(med_income = median_income_dollars) |>
  rename(total_pop_2020 = total_population)
```

## **Introduction**

Could exposure to lead increase one's likelihood of going to prison? After our team's systematic review of studies, we have explored the potential effects of lead exposure on brain development in children and adults. Various existing studies highlight the detrimental effects of lead on different brain regions, noticeable in a decrease in executive control and cognitive control, thereby affecting memory, mood, behavior and comprehension skills. Such exposure to lead during the developmental years of children causes irreversible damage, the effects of which can be seen later on in life. 

Studies in the past, such as one conducted by Talayero et al. (2023)^1^, have highlighted a strong association between lead exposure during childhood and criminal tendencies during adulthood. One can be exposed to lead through different means, including water, which is the medium which we’ve chosen to investigate. Our research topic inquires about whether a relationship exists between a specified area's water lead levels and its incarceration rates, while also considering potential confounding effects of other demographic factors.

This research topic has important societal implications, namely the complicated intersection of crime, environmental racism, and more. It’s an ever relevant question today and we hope to come to meaningful conclusions by the end of our analysis. Our initial hypothesis is that there is a positive relationship between water lead levels and the rate of incarceration with the existence of other interaction effects from things such as race and income. However, we acknowledge the intricate combination of social and institutional factors that increases one's likelihood of incarceration and are understand the possibility for inconclusive findings with the focus on lead exposure.

1\. [The association between lead exposure and crime: A systematic review](https://pmc.ncbi.nlm.nih.gov/articles/PMC10393136/#pgph.0002177.ref019)

## **Exploratory Data Analysis**

### **Our Data**

We've chosen to create our dataframe from a variety of census data relating to California in 2020. Our data looks at different California census tracts and their respective statistics relating to blood lead levels, income, incarceration rates, and racial demographics. For our analysis, we are particularly focused on `perc_bll_indicator`, `med_income`, our age and race variables and how well they can predict `imprisonment_rt`. HOW WAS OUR DATA COLLECTED. HOW DID WE CLEAN THE DATA.

#### **Univariate Data Exploration**

```{r}
#| label: lead-dist-code
#| echo: false
#| fig-show: hide

bll_limit <- quantile(bll_data$perc_bll_indicator, 0.99, na.rm = TRUE)

bll_data |>
  ggplot(aes(x = perc_bll_indicator)) +
  geom_histogram(color = "black", fill = "lightblue4") +
  scale_x_continuous(limits = c(0, 12.5)) +
  scale_y_continuous(limits = c(0, 1000)) +
  labs(
    title = "Distribution of Children Under 6 
with High Blood Lead Levels in CA",
    subtitle = "by Census Tract",
    x = "Children under 6 with a BLL ≥3.5 µg/dL (%)",
    y = "Count",
    caption = "Capturing ~99% of data"
  ) +
  theme_classic()

bll_med <- median(bll_data$perc_bll_indicator, na.rm = TRUE)
bll_iqr <- IQR(bll_data$bll_indicator, na.rm = TRUE)
```

**Blood Lead Levels (Figure 1):** There are 94 census tracts that didn't test blood lead levels in this data. These will likely need to be removed because these observations are not useful in the analysis. Additionally, there is a large concentration of census tracts that have a percent blood level indicator of 0 (1899 observations). While these should probably be included in the final analysis, removing these for data visualization produces a unimodal distributon that is heavily right skewed. Overall, the median blood level is `r bll_med` and the IQR is `r bll_iqr`.

```{r}
#| label: carc-dist-code
#| echo: false
#| fig-show: hide

carc_limit <- quantile(bll_data$imprisonment_rt, 0.99, na.rm = TRUE)

bll_data %>%
  ggplot(aes(x = imprisonment_rt)) +
  geom_histogram(color = "black", fill = "lightblue4") +
  scale_x_continuous(limits = c(0, 1250)) +
  labs(
    title = "Distribution of Imprisonment Rates in CA",
    subtitle = "per 100,000 by Census Tract",
    x = "Imprisonment Rate (per 100,000)",
    y = "Count",
    caption = "Capturing ~99% of data"
  ) + theme_classic() + 
  theme(plot.title = element_text(size = 10))

carc_med <- median(bll_data$imprisonment_rt, na.rm = TRUE)
carc_iqr <- IQR(bll_data$imprisonment_rt, na.rm = TRUE)
```

```{r}
#| label: income-code
#| echo: false
#| fig-show: hide

inc_limit <- quantile(bll_data$med_income, 0.99, na.rm = TRUE)

bll_data |>
  ggplot(aes(x = med_income)) +
  geom_histogram(color = "black", fill = "lightblue4") +
  scale_x_continuous(limits = c(0, 200000)) +
  scale_y_continuous(limits = c(0, 1000)) +
  labs(
    title = "Distribution of Median Income in CA",
    subtitle = "by Census Tract",
    x = "Median Income ($)",
    y = "Count",
    caption = "Capturing ~99% of data"
  ) + theme_classic() +
  theme(plot.title = element_text(size = 10))

inc_med <- median(bll_data$med_income, na.rm = TRUE)
inc_iqr <- IQR(bll_data$med_income, na.rm = TRUE)
```

**Incarceration Rate (Figure 2):** After removing extreme outliers (the top 1% incarceration rates - some may ultimately be removed because the census tract has an extremely low population ex. \~3 people), the shape of the distribution is unimodal and right skewed. The median incarceration rate is `r carc_med` out of 100,000 with an IQR of `r carc_iqr`. This doesn't appear surprising - there are fewer census tracts with particularly high imprisonment rates.

**Income (Figure 3):** The shape of the income distribution is also unimodal with a less extreme right skew and a median value of `r inc_med` and iqr of `r_inc_iqr`. This doesn't appear surprising - we'd expect median incomes of tracts to be concentrated towards the left.

**Spatial Distribution (Figure 4):** Given the spatial nature of this investigation, it is important to understand how the reported lead levels vary across the state. This map shows that there are contiguous series of tracts, especially in the Los Angeles region, where there may be spatial correlation. This is not surprising, as we expect water conditions across tracts to be similar.

#### **Bivariate Data Exploration (WE SHOULD EXPAND MORE ON THIS)**

```{r}
#| label: bivariate-exploration-code
#| Message: False
#| Warning: False
#| eval: false
#| fig-show: hide


ggprison <- bll_data %>% 
  filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
  filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm =
                                       TRUE)) %>% 
  filter(num_bll != 0) %>% 
  filter(perc_bll_indicator != 0) %>%
  ggplot(aes(y = imprisonment_rt, x = perc_bll_indicator)) +
  geom_point(alpha = 0.6, size = 0.6, color = "lightblue4") +
  geom_smooth(method = "lm", se = FALSE, size = 0.6, color = "black", linetype = 2) +
  labs(title = "Imprisonment Rate vs. Blood BLL Indicator",
       y = "Imprisonment Rate",
       x = "Percentage with BLL Indicator",
       caption = "Filtering out tracts who either had perc_bll_indicatr = 0% or that tested 0 people") +
  theme_classic()



ggincome <- bll_data %>% 
  filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
  filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm = TRUE)) %>% 
  filter(num_bll != 0) %>% 
  ggplot(aes(y = imprisonment_rt, x = med_income)) +
  geom_point(alpha = 0.6, size = 0.6, color = "lightblue4") +
  geom_smooth(method = "lm", se = FALSE, size = 0.6, color = "black", linetype = 2) +
  labs(title = "Imprisonment Rate vs. Median Income",
       y = "Imprisonment Rate",
       x = "Median Income") +
  theme_classic()



ggage<- bll_data %>% 
  filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
  filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm = TRUE)) %>% 
  filter(num_bll != 0) %>% 
  ggplot(aes(x = age_15_to_29, y = imprisonment_rt)) +
  geom_point(alpha = 0.6, size = 0.6, color = "lightblue4") +
  geom_smooth(method = "lm", se = FALSE, size = 0.6, color = "black", linetype = 2) +
  labs(title = "Imprisonment Rate vs. percentage age 15-29",
       y = "Imprisonment Rate",
       x = "Percentage of population age 15-29") +
  theme_classic()  

ggprison + ggage
ggincome
```

**Imprisonment vs BLL Indicator (Figure 5):** Imprisonment rate and the percentage of a census tract with a high bll has a generally positive correlation.

**Imprisonment vs BLL Indicator (Figure 6):** Imprisonment rate and percentage of population aged 15-29 in the census tract has a generally positive correlation.

**Imprisonment vs Median Income (Figure 7):** Imprisonment rate and median income has a generally negative correlation.

**Potential Interactions**

```{r}
#| label: interaction-effects

bll_data <- bll_data %>%
  mutate(POC_other = black + native_am + other_race, 
         race_categorical = ifelse(POC_other > median(POC_other, na.rm = TRUE), 
                                   "above_median_poc_other", 
                                   "below_median_poc_other"))

bll_data %>% 
filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm = TRUE)) %>% 
filter(num_bll != 0) %>% 
ggplot(aes(x = med_income, y = imprisonment_rt, color = race_categorical)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Relationship between income and imprisonment",
    subtitle = "By median percentages of Black, Native American, and other races",
    x = "Median Income",
    y = "Imprisonment Rate",
    color = "Above or below median"
  ) +
  theme_minimal()
```

When comparing the relationship between median income and imprisonment rate, it appears that generally they have a negative correlation. This graph suggests there could be an interaction effect between race and income, as the relationship between median income and imprisonment rate differs by race. We created a categorical variable for the percentage of the census tract population that is black, native american, or "other race" that is categorically above or below the median in the data. The relationship between imprisonment rate and median income appears more negatively correlated when categorically above the median census tract population percentage of black, native american, and other_race. This supports that there could be an interaction effect between race and income.

**Checking Initial Modelling Conditions**

```{r}
#| label: intial-conditions
library(knitr)

#filtering data points where num_bll = 0
bll_data_checking <- bll_data %>% 
  filter(num_bll != 0)

bll_full_model <- lm(imprisonment_rt ~ perc_bll_indicator + POC_other + med_income + median_age + perc_male + med_income * POC_other, data = bll_data) 

tidy(bll_full_model) %>% 
kable(digits = 3)

set.seed(210)

full_model_aug <- augment(bll_full_model)

#there is one point with a residual so large the graph is not readable if we keep it. Filtering it out.
full_model_aug |>
  filter(.rownames != 2421) %>% 
  filter(.std.resid < 80) %>% 
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Residuals vs Fitted Values",
    x = "Fitted",
    y = "Standardized Residuals"
  )

vif_fm <- vif(bll_full_model)
vif_fm

#There does not appear to be too much multicollinearity.

```

1.  Normality condition can be relaxed.
2.  Linearity condition not satisfied. Points not randomly scattered around the x = 0 line.
3.  Constant variance condition not satisfied. Points fan out across the x = 0 line.
4.  Independence condition also may not be satisfied. Census tracts next to each other could be more likely to have similar incarceration rates or blood lead levels.

```{r}
#| label: condition-checking
#Now going to check for the need to transform any variables

bll_data_checking %>% 
  filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm = TRUE)) %>% 
 select(imprisonment_rt, perc_bll_indicator, med_income, median_age) %>%
 ggpairs()
```

```{r}
#| label: log_transformation
#used +1 to avoid log(0) issues? Idk that was new for me and not sure we need to keep it.
bll_data_transformed <- bll_data_checking %>%
  mutate(
    log_med_income = log(med_income + 1),       
    log_imprisonment_rt = log(imprisonment_rt + 1) 
  ) %>% 
  filter(imprisonment_rt != 0)

log_model_checking <- lm(log_imprisonment_rt ~ log_med_income + perc_bll_indicator + 
                POC_other + median_age + perc_male, data = bll_data_transformed)

log_model_checking_aug <- augment(log_model_checking)

log_model_checking_aug |>
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Standardized Residuals vs Fitted Values",
    x = "Fitted",
    y = "Standardized Residuals"
  )


vif_fm_log <- vif(log_model_checking)
vif_fm_log

#Stripe is gone- happened after removing census tracts where imprisonment rate is equal to zero. We can leave the stripe in for this analysis and attribute it to these tracts.

```

**Splitting the Data**

We were concerned about spatial correlation, so originally split the data with 20% in training and 80% testing to minimize this effect. We received abysmal R squared values when doing this. We are going to perform a form of cross validation called spatial cross validation to address model overfitting and independence issues within our data. Because we are addressing the independence problem using this method, we can now do 80% training and 20% testing. For this, we used ChatGPT to suggest solutions. It suggested spatial cross validation, which we researched further using this source: https://r.geocompx.org/spatial-cv

```{r}
#| label: loading-required-packages

#install.packages("tigris")
#install.packages("sf")
#install.packages("blockCV")
library(blockCV)
library(tigris)
library(sf)



```

```{r}
#| label: joining-shapefiles-to-bl-data

ca_tracts <- tracts(state = "CA", cb = TRUE, year = 2020)

ca_tracts <- ca_tracts %>%
  mutate(GEOID = as.character(GEOID))

bll_data_transformed <- bll_data_transformed %>%
  mutate(census_tract = as.character(census_tract)) 

bll_data_geo <- left_join(ca_tracts, bll_data_transformed, by = c("GEOID" = "census_tract"))

bll_data_geo <- bll_data_geo %>%
  filter(!is.na(log_imprisonment_rt), 
         !is.na(log_med_income),
         !is.na(perc_bll_indicator),
         !is.na(POC_other),
         !is.na(median_age),
         !is.na(perc_male))
```

```{r}
#| label: spatial-cross-validation
#If training census tracts are next to testing census tracts, this could create spatial bias in the model. To address this, we employed spatial cross validation, which splits the data into folds that are distant from each other.

#Best sources explaining what is happening

#https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13107
#https://www.frontiersin.org/journals/remote-sensing/articles/10.3389/frsen.2025.1531097/full

#Other sources

#https://stats.stackexchange.com/questions/460905/data-partitioning-for-spatial-data
#https://esajournals.onlinelibrary.wiley.com/doi/10.1002/ecm.1557

set.seed(210)

spatial_folds <- spatialBlock(
  speciesData = bll_data_geo,
  theRange = 100000,  #we split the data into 5 regions, each totally 100km.
  k = 5,
  selection = "random",
  iteration = 100,
  showBlocks = TRUE
)

bll_data_geo$fold <- spatial_folds$foldID

```

```{r}
#| label: plotting-lead-levels

bll_data_geo <- bll_data_geo %>%
  mutate(lead_category = case_when(
    perc_bll_indicator < 0.5 ~ "< 0.5%",
    perc_bll_indicator < 1 ~ "0.5–1%",
    perc_bll_indicator < 2 ~ "1–2%",
    perc_bll_indicator < 5 ~ "2–5%",
    TRUE ~ ">5%"
  )) 

ggplot(bll_data_geo) +
  geom_sf(aes(fill = lead_category), color = NA) +
  scale_fill_viridis_d(option = "plasma", na.value = "grey80") +
  labs(
    title = "Blood Lead Level Categories by Census Tract",
    fill = "Lead Level Category"
  ) 
```

```{r}
#| label: splitting

#we assign 3 folds to the training data and 2 to the testing data

train_folds <- c(1, 2, 3, 4)
test_folds  <- c(5)

bll_train <- bll_data_geo %>%
  filter(fold %in% train_folds)

bll_test <- bll_data_geo %>%
  filter(fold %in% test_folds)

```

```{r}
#| label: removing-influential-points
#choosing interaction model

log_model_actual <- lm(log_imprisonment_rt ~ log_med_income + perc_bll_indicator + 
                POC_other + median_age + perc_male + POC_other * log_med_income, data = bll_train)

log_model_actual_aug <- augment(log_model_actual)

log_model_actual_aug |>
  ggplot(aes(x = .fitted, y = .std.resid, color = .cooksd)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Standardized Residuals vs Fitted Values",
    x = "Fitted Value",
    y = "Standardized Residual",
    color = "Cook's Distance"
  ) +
  scale_color_viridis_c() +
  theme_minimal() 

#log_model_actual_aug %>% 
  #filter(.cooksd >= 0.5) %>% 
  #select(.hat, .std.resid, .cooksd)

tidy(log_model_actual) %>% 
  kable(digits = 3)

#It does not appear there are any data points in the training data with a cook's distance greater than 0.5. Therefore, none need to be removed.
```

```{r}
#| label: model-selection

library(MASS)


stepwise_model_forced <- stepAIC(
  log_model_actual,
  scope = list(
    lower = ~ perc_bll_indicator, 
    upper = ~ log_med_income + perc_bll_indicator + POC_other + median_age + perc_male + POC_other * log_med_income
  ),
  direction = "both",
  trace = 1
)

summary(stepwise_model_forced)

tidy(stepwise_model_forced) %>%
  kable(digits = 3)

#Interestingly, the lead predictor was removed originally through stepwise selection, perhaps indicating that it is not useful here. We are going to force it back into the model since it is a variable of interest.

```

```{r}
#| label: model-evaluation

log_predictions <- predict(log_model_actual, newdata = bll_test)

bll_test <- bll_test %>%
  mutate(imprisonment_rate = exp(log_imprisonment_rt))

bll_test_results <- bll_test %>%
  mutate(predicted = exp(log_predictions)) %>%
  dplyr::select(imprisonment_rate, predicted)

metrics_table <- bll_test_results %>%
  yardstick::metrics(truth = imprisonment_rate, estimate = predicted) %>% 
  filter(.metric %in% c("rmse", "rsq"))

metrics_table %>%
  kable(digits = 3, caption = "Model Performance (RMSE and R-squared)")

```

```{r}
#| label: checking-effects-of-block-CV

#how do we know that the spatial CV successfully addressed the independence problem?
#We would expect the models to be worse predictors on the spatial CV data. 

#randomly split data

set.seed(210)
random_split <- initial_split(bll_data_geo, prop = 0.8)
bll_train_random <- training(random_split)
bll_test_random  <- testing(random_split)

log_model_actual2 <- lm(log_imprisonment_rt ~ log_med_income + perc_bll_indicator + 
                POC_other + median_age + perc_male + POC_other * log_med_income, data = bll_train_random)

stepwise_model_forced2 <- stepAIC(
  log_model_actual2,
  scope = list(
    lower = ~ perc_bll_indicator, 
    upper = ~ log_med_income + perc_bll_indicator + POC_other + median_age + perc_male + POC_other * log_med_income
  ),
  direction = "both",
  trace = 1
)

log_predictions2 <- predict(log_model_actual2, newdata = bll_test_random)

bll_test_random <- bll_test_random %>%
  mutate(imprisonment_rate = exp(log_imprisonment_rt))

bll_test_results2 <- bll_test_random %>%
  mutate(predicted = exp(log_predictions2)) %>%
  dplyr::select(imprisonment_rate, predicted)

metrics_table <- bll_test_results2 %>%
  yardstick::metrics(truth = imprisonment_rate, estimate = predicted) %>% 
  filter(.metric %in% c("rmse", "rsq"))

metrics_table %>%
  kable(digits = 3, caption = "Random-Split Model Performance (RMSE and R-squared)")

#the R squared value for the random split is higher, which is odd.
  
```

```{r}
summary(log_model_actual)$r.squared
summary(log_model_actual2)$r.squared
```

```{r, eval = FALSE}
bll_data_geo %>%
  count(fold) %>%
  arrange(fold) %>%
  kable(digits = 0, caption = "Sample Size per Spatial Fold")
```

## **Appendix**

### **EDA**

```{r}
#| label: lead-dist-plot
#| fig.cap: "Figure 1: Distribution of lead in children"

bll_limit <- quantile(bll_data$perc_bll_indicator, 0.99, na.rm = TRUE)

bll_data |>
  ggplot(aes(x = perc_bll_indicator)) +
  geom_histogram(color = "black", fill = "lightblue4") +
  scale_x_continuous(limits = c(0, 12.5)) +
  scale_y_continuous(limits = c(0, 1000)) +
  labs(
    title = "Distribution of Children Under 6 
with High Blood Lead Levels in CA",
    subtitle = "by Census Tract",
    x = "Children under 6 with a BLL ≥3.5 µg/dL (%)",
    y = "Count",
    caption = "Figure 1"
  ) +
  theme_classic()

bll_med <- median(bll_data$perc_bll_indicator, na.rm = TRUE)
bll_iqr <- IQR(bll_data$bll_indicator, na.rm = TRUE)
```

```{r}
#| label: carc-dist

carc_limit <- quantile(bll_data$imprisonment_rt, 0.99, na.rm = TRUE)

bll_data %>%
  ggplot(aes(x = imprisonment_rt)) +
  geom_histogram(color = "black", fill = "lightblue4") +
  scale_x_continuous(limits = c(0, 1250)) +
  labs(
    title = "Distribution of Imprisonment Rates in CA",
    subtitle = "per 100,000 by Census Tract",
    x = "Imprisonment Rate (per 100,000)",
    y = "Count",
    caption = "Figure 3"
  ) + theme_classic()

carc_med <- median(bll_data$imprisonment_rt, na.rm = TRUE)
carc_iqr <- IQR(bll_data$imprisonment_rt, na.rm = TRUE)
```

```{r}
#| label: income-code-plot

inc_limit <- quantile(bll_data$med_income, 0.99, na.rm = TRUE)

bll_data |>
  ggplot(aes(x = med_income)) +
  geom_histogram(color = "black", fill = "lightblue4") +
  scale_x_continuous(limits = c(0, 200000)) +
  scale_y_continuous(limits = c(0, 1000)) +
  labs(
    title = "Distribution of Median Income in CA",
    subtitle = "by Census Tract",
    x = "Median Income ($)",
    y = "Count",
    caption = "Figure 3"
  ) + theme_classic()

inc_med <- median(bll_data$med_income, na.rm = TRUE)
inc_iqr <- IQR(bll_data$med_income, na.rm = TRUE)
```

![Spatial Distribution of BLL in California](data/Layout.png){width="200"}

```{r}
#| label: bivariate-exploration
#| Message: False
#| Warning: False

bll_data %>% 
  filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
  filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm =
                                       TRUE)) %>% 
  filter(num_bll != 0) %>% 
  filter(perc_bll_indicator != 0) %>%
  ggplot(aes(y = imprisonment_rt, x = perc_bll_indicator)) +
  geom_point(alpha = 0.6, size = 0.6, color = "lightblue4") +
  geom_smooth(method = "lm", se = FALSE, size = 0.6, color = "black", linetype = 2) +
  labs(title = "Imprisonment Rate vs. Blood BLL Indicator",
       y = "Imprisonment Rate",
       x = "Percentage with BLL Indicator",
       caption = "Figure 4"
       ) +
  theme_classic()

#Filtering out tracts who either had perc_bll_indicatr = 0% or that tested 0 people



bll_data %>% 
  filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
  filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm = TRUE)) %>% 
  filter(num_bll != 0) %>% 
  ggplot(aes(y = imprisonment_rt, x = med_income)) +
  geom_point(alpha = 0.6, size = 0.6, color = "lightblue4") +
  geom_smooth(method = "lm", se = FALSE, size = 0.6, color = "black", linetype = 2) +
  labs(title = "Imprisonment Rate vs. Median Income",
       y = "Imprisonment Rate",
       x = "Median Income",
       caption = "Figure 5"
       ) +
  theme_classic()



bll_data %>% 
  filter(perc_bll_indicator <= quantile(perc_bll_indicator, 0.98, na.rm = TRUE)) %>% 
  filter(imprisonment_rt <= quantile(imprisonment_rt, 0.98, na.rm = TRUE)) %>% 
  filter(num_bll != 0) %>% 
  ggplot(aes(x = age_15_to_29, y = imprisonment_rt)) +
  geom_point(alpha = 0.6, size = 0.6, color = "lightblue4") +
  geom_smooth(method = "lm", se = FALSE, size = 0.6, color = "black", linetype = 2) +
  labs(title = "Imprisonment Rate vs. percentage age 15-29",
       y = "Imprisonment Rate",
       x = "Percentage of population age 15-29",
       caption = "Figure 6"
       ) +
  theme_classic()  
```
